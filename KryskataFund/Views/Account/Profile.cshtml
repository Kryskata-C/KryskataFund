@{
    ViewData["Title"] = "My Profile";
    var user = ViewBag.User as KryskataFund.Models.User;
    var createdFunds = ViewBag.CreatedFunds as List<KryskataFund.Models.Fund> ?? new List<KryskataFund.Models.Fund>();
    var donations = ViewBag.Donations as List<KryskataFund.Models.Donation> ?? new List<KryskataFund.Models.Donation>();
    var totalRaised = ViewBag.TotalRaised ?? 0m;
    var totalDonated = ViewBag.TotalDonated ?? 0m;
    var totalSupporters = ViewBag.TotalSupporters ?? 0;
    var memberSince = user?.CreatedAt.ToString("MMMM yyyy") ?? "Unknown";
    var username = "@" + (user?.Email.Split('@')[0] ?? "user");
    var buddyGlasses = ViewBag.BuddyGlasses as string;
    var buddyHat = ViewBag.BuddyHat as string;
    var buddyMask = ViewBag.BuddyMask as string;
}

<div class="profile-page">
    <!-- Emergence animation container -->
    <div class="emergence-container" id="emergenceContainer">
        <div class="emergence-portal">
            <div class="emergence-ring"></div>
            <div class="emergence-ring"></div>
            <div class="emergence-ring"></div>
        </div>
        <div class="emergence-buddy" id="emergenceBuddy">
            <div class="buddy-body large">
                <div class="buddy-face">
                    <div class="buddy-eyes">
                        <div class="buddy-eye left">
                            <div class="buddy-pupil"></div>
                        </div>
                        <div class="buddy-eye right">
                            <div class="buddy-pupil"></div>
                        </div>
                    </div>
                    <div class="buddy-mouth"></div>
                    <div class="buddy-blush left"></div>
                    <div class="buddy-blush right"></div>
                </div>
                <!-- Customization layers -->
                <div class="buddy-accessory buddy-glasses @(buddyGlasses != null ? $"glasses-{buddyGlasses}" : "")"></div>
                <div class="buddy-accessory buddy-hat @(buddyHat != null ? $"hat-{buddyHat}" : "")"></div>
                <div class="buddy-accessory buddy-mask @(buddyMask != null ? $"mask-{buddyMask}" : "")"></div>
            </div>
            <div class="buddy-glow large"></div>
        </div>
        <div class="emergence-particles" id="emergenceParticles"></div>
    </div>

    <!-- Profile content (hidden until animation completes) -->
    <div class="profile-content" id="profileContent">
        <div class="profile-header">
            <a asp-controller="Home" asp-action="Index" class="back-link">
                <span class="back-arrow">‚Üê</span>
                Back to campaigns
            </a>
        </div>

        <div class="profile-grid">
            <!-- Main profile card -->
            <section class="profile-card profile-main">
                <div class="profile-avatar-section">
                    <div class="profile-avatar-buddy" id="avatarBuddy" title="Click to customize!">
                        <div class="buddy-body medium" id="previewBuddy">
                            <div class="buddy-face">
                                <div class="buddy-eyes">
                                    <div class="buddy-eye left">
                                        <div class="buddy-pupil"></div>
                                    </div>
                                    <div class="buddy-eye right">
                                        <div class="buddy-pupil"></div>
                                    </div>
                                </div>
                                <div class="buddy-mouth"></div>
                                <div class="buddy-blush left"></div>
                                <div class="buddy-blush right"></div>
                            </div>
                            <!-- Customization layers -->
                            <div class="buddy-accessory buddy-glasses" id="previewGlasses" data-current="@buddyGlasses"></div>
                            <div class="buddy-accessory buddy-hat" id="previewHat" data-current="@buddyHat"></div>
                            <div class="buddy-accessory buddy-mask" id="previewMask" data-current="@buddyMask"></div>
                        </div>
                        <div class="buddy-glow medium"></div>
                        <div class="customize-hint">‚ú® Click to customize!</div>
                    </div>
                </div>

                <div class="profile-info">
                    <h1 class="profile-username">@username</h1>
                    <p class="profile-email">@user?.Email</p>
                    <div class="profile-meta">
                        <span class="profile-badge">
                            <span class="badge-icon">‚ú®</span>
                            Member since @memberSince
                        </span>
                    </div>
                </div>

                <div class="profile-stats-grid">
                    <div class="profile-stat">
                        <span class="stat-value">‚Ç¨@(((decimal)totalRaised).ToString("N0"))</span>
                        <span class="stat-label">Total raised</span>
                    </div>
                    <div class="profile-stat">
                        <span class="stat-value">‚Ç¨@(((decimal)totalDonated).ToString("N0"))</span>
                        <span class="stat-label">Total donated</span>
                    </div>
                    <div class="profile-stat">
                        <span class="stat-value">@createdFunds.Count</span>
                        <span class="stat-label">Funds created</span>
                    </div>
                    <div class="profile-stat">
                        <span class="stat-value">@donations.Count</span>
                        <span class="stat-label">Donations made</span>
                    </div>
                </div>

                <div class="profile-actions">
                    <a asp-controller="Funds" asp-action="Create" class="btn-profile-action primary">
                        <span>+</span> Create New Fund
                    </a>
                    <a asp-controller="Account" asp-action="SignOut" class="btn-profile-action secondary">
                        <span>üëã</span> Sign Out
                    </a>
                </div>
            </section>

            <!-- My Funds section -->
            <section class="profile-card profile-funds">
                <div class="section-header">
                    <h2>My Funds</h2>
                    <span class="section-count">@createdFunds.Count funds</span>
                </div>

                @if (createdFunds.Count == 0)
                {
                    <div class="empty-section">
                        <div class="empty-icon">üöÄ</div>
                        <p>You haven't created any funds yet</p>
                        <a asp-controller="Funds" asp-action="Create" class="btn-empty">Create your first fund</a>
                    </div>
                }
                else
                {
                    <div class="funds-list">
                        @foreach (var fund in createdFunds.Take(5))
                        {
                            <a asp-controller="Funds" asp-action="Details" asp-route-id="@fund.Id" class="fund-item">
                                <div class="fund-item-image" style="@(fund.ImageUrl != null ? $"background: url('{fund.ImageUrl}') center/cover;" : $"background: linear-gradient(135deg, {fund.CategoryColor}, #4da8ff);")"></div>
                                <div class="fund-item-info">
                                    <h3>@fund.Title</h3>
                                    <div class="fund-item-meta">
                                        <span class="fund-item-progress">@fund.ProgressPercent% funded</span>
                                        <span>‚Ç¨@fund.RaisedAmount.ToString("N0") raised</span>
                                    </div>
                                    <div class="fund-item-bar">
                                        <div class="fund-item-fill" style="width: @Math.Min(100, fund.ProgressPercent)%;"></div>
                                    </div>
                                </div>
                            </a>
                        }
                    </div>
                }
            </section>

            <!-- My Donations section -->
            <section class="profile-card profile-donations">
                <div class="section-header">
                    <h2>My Donations</h2>
                    <span class="section-count">@donations.Count donations</span>
                </div>

                @if (donations.Count == 0)
                {
                    <div class="empty-section">
                        <div class="empty-icon">üíö</div>
                        <p>You haven't made any donations yet</p>
                        <a asp-controller="Home" asp-action="Index" class="btn-empty">Discover campaigns</a>
                    </div>
                }
                else
                {
                    <div class="donations-list">
                        @foreach (var donation in donations.Take(5))
                        {
                            var fund = createdFunds.FirstOrDefault(f => f.Id == donation.FundId);
                            <div class="donation-item">
                                <div class="donation-amount">‚Ç¨@donation.Amount.ToString("N0")</div>
                                <div class="donation-info">
                                    <span class="donation-fund">Fund #@donation.FundId</span>
                                    <span class="donation-date">@donation.CreatedAt.ToString("MMM d, yyyy")</span>
                                </div>
                            </div>
                        }
                    </div>
                }
            </section>
        </div>
    </div>

    <!-- Customization Modal -->
    <div class="customize-modal" id="customizeModal">
        <div class="customize-backdrop" id="customizeBackdrop"></div>
        <div class="customize-panel">
            <div class="customize-header">
                <h2>‚ú® Customize Your Buddy</h2>
                <button class="customize-close" id="customizeClose">√ó</button>
            </div>

            <div class="customize-preview">
                <div class="preview-buddy-container">
                    <div class="buddy-body xlarge" id="modalPreviewBuddy">
                        <div class="buddy-face">
                            <div class="buddy-eyes">
                                <div class="buddy-eye left">
                                    <div class="buddy-pupil"></div>
                                </div>
                                <div class="buddy-eye right">
                                    <div class="buddy-pupil"></div>
                                </div>
                            </div>
                            <div class="buddy-mouth"></div>
                            <div class="buddy-blush left"></div>
                            <div class="buddy-blush right"></div>
                        </div>
                        <div class="buddy-accessory buddy-glasses" id="modalGlasses"></div>
                        <div class="buddy-accessory buddy-hat" id="modalHat"></div>
                        <div class="buddy-accessory buddy-mask" id="modalMask"></div>
                    </div>
                    <div class="buddy-glow xlarge"></div>
                </div>
            </div>

            <div class="customize-tabs">
                <button class="customize-tab active" data-tab="glasses">üï∂Ô∏è Glasses</button>
                <button class="customize-tab" data-tab="hats">üé© Hats</button>
                <button class="customize-tab" data-tab="masks">üé≠ Masks</button>
            </div>

            <div class="customize-content">
                <!-- Glasses Tab -->
                <div class="customize-options active" id="glassesTab">
                    <div class="option-item" data-type="glasses" data-value="">
                        <div class="option-preview none">None</div>
                        <span>None</span>
                    </div>
                    <div class="option-item" data-type="glasses" data-value="round">
                        <div class="option-preview"><div class="mini-glasses glasses-round"></div></div>
                        <span>Round</span>
                    </div>
                    <div class="option-item" data-type="glasses" data-value="nerd">
                        <div class="option-preview"><div class="mini-glasses glasses-nerd"></div></div>
                        <span>Nerd</span>
                    </div>
                    <div class="option-item" data-type="glasses" data-value="sunglasses">
                        <div class="option-preview"><div class="mini-glasses glasses-sunglasses"></div></div>
                        <span>Shades</span>
                    </div>
                    <div class="option-item" data-type="glasses" data-value="cyber">
                        <div class="option-preview"><div class="mini-glasses glasses-cyber"></div></div>
                        <span>Cyber</span>
                    </div>
                    <div class="option-item" data-type="glasses" data-value="heart">
                        <div class="option-preview"><div class="mini-glasses glasses-heart"></div></div>
                        <span>Heart</span>
                    </div>
                    <div class="option-item" data-type="glasses" data-value="monocle">
                        <div class="option-preview"><div class="mini-glasses glasses-monocle"></div></div>
                        <span>Monocle</span>
                    </div>
                </div>

                <!-- Hats Tab -->
                <div class="customize-options" id="hatsTab">
                    <div class="option-item" data-type="hats" data-value="">
                        <div class="option-preview none">None</div>
                        <span>None</span>
                    </div>
                    <div class="option-item" data-type="hats" data-value="crown">
                        <div class="option-preview"><div class="mini-hat hat-crown"></div></div>
                        <span>Crown</span>
                    </div>
                    <div class="option-item" data-type="hats" data-value="beanie">
                        <div class="option-preview"><div class="mini-hat hat-beanie"></div></div>
                        <span>Beanie</span>
                    </div>
                    <div class="option-item" data-type="hats" data-value="tophat">
                        <div class="option-preview"><div class="mini-hat hat-tophat"></div></div>
                        <span>Top Hat</span>
                    </div>
                    <div class="option-item" data-type="hats" data-value="cap">
                        <div class="option-preview"><div class="mini-hat hat-cap"></div></div>
                        <span>Cap</span>
                    </div>
                    <div class="option-item" data-type="hats" data-value="halo">
                        <div class="option-preview"><div class="mini-hat hat-halo"></div></div>
                        <span>Halo</span>
                    </div>
                    <div class="option-item special" data-type="hats" data-value="imene">
                        <div class="option-preview"><div class="mini-hat hat-imene"></div></div>
                        <span>–∏ –º–µ–Ω–µ</span>
                    </div>
                </div>

                <!-- Masks Tab -->
                <div class="customize-options" id="masksTab">
                    <div class="option-item" data-type="masks" data-value="">
                        <div class="option-preview none">None</div>
                        <span>None</span>
                    </div>
                    <div class="option-item" data-type="masks" data-value="ninja">
                        <div class="option-preview"><div class="mini-mask mask-ninja"></div></div>
                        <span>Ninja</span>
                    </div>
                    <div class="option-item" data-type="masks" data-value="oni">
                        <div class="option-preview"><div class="mini-mask mask-oni"></div></div>
                        <span>Oni</span>
                    </div>
                    <div class="option-item" data-type="masks" data-value="phantom">
                        <div class="option-preview"><div class="mini-mask mask-phantom"></div></div>
                        <span>Phantom</span>
                    </div>
                    <div class="option-item" data-type="masks" data-value="gas">
                        <div class="option-preview"><div class="mini-mask mask-gas"></div></div>
                        <span>Gas Mask</span>
                    </div>
                    <div class="option-item" data-type="masks" data-value="cyber">
                        <div class="option-preview"><div class="mini-mask mask-cyber"></div></div>
                        <span>Cyber</span>
                    </div>
                    <div class="option-item" data-type="masks" data-value="cat">
                        <div class="option-preview"><div class="mini-mask mask-cat"></div></div>
                        <span>Cat</span>
                    </div>
                    <div class="option-item" data-type="masks" data-value="skull">
                        <div class="option-preview"><div class="mini-mask mask-skull"></div></div>
                        <span>Skull</span>
                    </div>
                    <div class="option-item" data-type="masks" data-value="kitsune">
                        <div class="option-preview"><div class="mini-mask mask-kitsune"></div></div>
                        <span>Kitsune</span>
                    </div>
                    <div class="option-item" data-type="masks" data-value="glitch">
                        <div class="option-preview"><div class="mini-mask mask-glitch"></div></div>
                        <span>Glitch</span>
                    </div>
                    <div class="option-item" data-type="masks" data-value="neon">
                        <div class="option-preview"><div class="mini-mask mask-neon"></div></div>
                        <span>Neon</span>
                    </div>
                </div>
            </div>

            <div class="customize-actions">
                <button class="btn-customize-reset" id="resetBtn">Reset All</button>
                <button class="btn-customize-save" id="saveBtn">üíæ Save Changes</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // === EMERGENCE ANIMATION ===
            const shouldAnimate = sessionStorage.getItem('buddyEmerging') === 'true';
            const emergenceContainer = document.getElementById('emergenceContainer');
            const profileContent = document.getElementById('profileContent');
            const emergenceBuddy = document.getElementById('emergenceBuddy');
            const emergenceParticles = document.getElementById('emergenceParticles');

            if (shouldAnimate) {
                sessionStorage.removeItem('buddyEmerging');

                for (let i = 0; i < 16; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'emergence-particle';
                    particle.style.setProperty('--angle', (i * 22.5) + 'deg');
                    particle.style.setProperty('--delay', (i * 0.03) + 's');
                    emergenceParticles.appendChild(particle);
                }

                emergenceContainer.classList.add('active');
                emergenceBuddy.classList.add('emerging');

                setTimeout(() => {
                    emergenceContainer.classList.add('fade-out');
                    profileContent.classList.add('visible');
                }, 1200);

                setTimeout(() => {
                    emergenceContainer.style.display = 'none';
                }, 1800);
            } else {
                emergenceContainer.style.display = 'none';
                profileContent.classList.add('visible', 'no-animation');
            }

            // === CUSTOMIZATION SYSTEM ===
            const modal = document.getElementById('customizeModal');
            const avatarBuddy = document.getElementById('avatarBuddy');
            const closeBtn = document.getElementById('customizeClose');
            const backdrop = document.getElementById('customizeBackdrop');
            const saveBtn = document.getElementById('saveBtn');
            const resetBtn = document.getElementById('resetBtn');
            const tabs = document.querySelectorAll('.customize-tab');
            const optionContainers = document.querySelectorAll('.customize-options');

            // Current selections
            let currentGlasses = document.getElementById('previewGlasses').dataset.current || '';
            let currentHat = document.getElementById('previewHat').dataset.current || '';
            let currentMask = document.getElementById('previewMask').dataset.current || '';

            // Apply initial customization
            applyCustomization();

            // Open modal
            avatarBuddy.addEventListener('click', function() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                updateModalPreview();
                highlightSelected();
            });

            // Close modal
            function closeModal() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }

            closeBtn.addEventListener('click', closeModal);
            backdrop.addEventListener('click', closeModal);

            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    const tabName = this.dataset.tab;
                    optionContainers.forEach(container => {
                        container.classList.remove('active');
                        if (container.id === tabName + 'Tab') {
                            container.classList.add('active');
                        }
                    });
                });
            });

            // Option selection
            document.querySelectorAll('.option-item').forEach(item => {
                item.addEventListener('click', function() {
                    const type = this.dataset.type;
                    const value = this.dataset.value;

                    // Update selection
                    if (type === 'glasses') currentGlasses = value;
                    if (type === 'hats') currentHat = value;
                    if (type === 'masks') currentMask = value;

                    // Update preview
                    updateModalPreview();
                    highlightSelected();

                    // Add selection animation
                    this.classList.add('selected-animation');
                    setTimeout(() => this.classList.remove('selected-animation'), 300);
                });
            });

            // Update modal preview
            function updateModalPreview() {
                const modalGlasses = document.getElementById('modalGlasses');
                const modalHat = document.getElementById('modalHat');
                const modalMask = document.getElementById('modalMask');

                modalGlasses.className = 'buddy-accessory buddy-glasses' + (currentGlasses ? ' glasses-' + currentGlasses : '');
                modalHat.className = 'buddy-accessory buddy-hat' + (currentHat ? ' hat-' + currentHat : '');
                modalMask.className = 'buddy-accessory buddy-mask' + (currentMask ? ' mask-' + currentMask : '');
            }

            // Highlight selected options
            function highlightSelected() {
                document.querySelectorAll('.option-item').forEach(item => {
                    const type = item.dataset.type;
                    const value = item.dataset.value;
                    let isSelected = false;

                    if (type === 'glasses' && value === currentGlasses) isSelected = true;
                    if (type === 'hats' && value === currentHat) isSelected = true;
                    if (type === 'masks' && value === currentMask) isSelected = true;

                    item.classList.toggle('selected', isSelected);
                });
            }

            // Apply customization to profile buddy
            function applyCustomization() {
                const previewGlasses = document.getElementById('previewGlasses');
                const previewHat = document.getElementById('previewHat');
                const previewMask = document.getElementById('previewMask');

                previewGlasses.className = 'buddy-accessory buddy-glasses' + (currentGlasses ? ' glasses-' + currentGlasses : '');
                previewHat.className = 'buddy-accessory buddy-hat' + (currentHat ? ' hat-' + currentHat : '');
                previewMask.className = 'buddy-accessory buddy-mask' + (currentMask ? ' mask-' + currentMask : '');
            }

            // Save customization
            saveBtn.addEventListener('click', async function() {
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Saving...';

                try {
                    const response = await fetch('/Account/SaveBuddyCustomization', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `glasses=${encodeURIComponent(currentGlasses)}&hat=${encodeURIComponent(currentHat)}&mask=${encodeURIComponent(currentMask)}`
                    });

                    const data = await response.json();
                    if (data.success) {
                        applyCustomization();
                        saveBtn.textContent = '‚úÖ Saved!';
                        setTimeout(() => {
                            closeModal();
                            saveBtn.textContent = 'üíæ Save Changes';
                            saveBtn.disabled = false;
                        }, 800);
                    }
                } catch (error) {
                    saveBtn.textContent = '‚ùå Error';
                    setTimeout(() => {
                        saveBtn.textContent = 'üíæ Save Changes';
                        saveBtn.disabled = false;
                    }, 1500);
                }
            });

            // Reset customization
            resetBtn.addEventListener('click', function() {
                currentGlasses = '';
                currentHat = '';
                currentMask = '';
                updateModalPreview();
                highlightSelected();
            });
        });
    </script>
}
