@model KryskataFund.Models.Fund
@functions {
    string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        if (timeSpan.TotalMinutes < 1) return "just now";
        if (timeSpan.TotalMinutes < 60) return $"{(int)timeSpan.TotalMinutes} min ago";
        if (timeSpan.TotalHours < 24) return $"{(int)timeSpan.TotalHours} hours ago";
        if (timeSpan.TotalDays < 7) return $"{(int)timeSpan.TotalDays} days ago";
        return dateTime.ToString("MMM d");
    }
}
@{
    ViewData["Title"] = Model.Title;
    var progressPercent = Model.ProgressPercent;
    var isOverfunded = Model.RaisedAmount > Model.GoalAmount;
    var statusText = isOverfunded ? $"{progressPercent}% funded" : Model.DaysLeft == 0 ? "Ended" : $"{Model.DaysLeft} days left";
    var isSignedIn = ViewBag.IsSignedIn ?? false;
    var signInUrl = Url.Action("SignIn", "Account", new { returnUrl = Context.Request.Path });
}

<div class="page-root">
    <div class="page-shell">
        <!-- Back button -->
        <a asp-controller="Home" asp-action="Index" class="back-link">
            <span class="back-arrow">‚Üê</span>
            Back to campaigns
        </a>

        <div class="fund-detail-grid">
            <!-- Main content -->
            <section class="fund-detail-main">
                <!-- Hero image area -->
                <div class="fund-detail-hero" style="@(Model.ImageUrl != null ? $"background: url('{Model.ImageUrl}') center/cover;" : "")">
                    <div class="fund-detail-hero-gradient"></div>
                    <div class="fund-detail-category-tag" style="--cat-color: @Model.CategoryColor;">
                        <span class="fund-detail-tag-dot" style="background: @Model.CategoryColor; box-shadow: 0 0 10px @Model.CategoryColor;"></span>
                        @Model.Category
                    </div>
                    @if (isOverfunded)
                    {
                        <div class="fund-detail-badge fund-detail-badge--success">
                            Goal reached!
                        </div>
                    }
                </div>

                <!-- Title and story -->
                <div class="fund-detail-content">
                    <h1 class="fund-detail-title">@Model.Title</h1>

                    <div class="fund-detail-creator">
                        <div class="fund-detail-avatar" style="background: linear-gradient(135deg, @Model.CategoryColor, #4da8ff);"></div>
                        <span>Created by <strong>@Model.CreatorName</strong></span>
                    </div>

                    <div class="fund-detail-story">
                        <h2>About this campaign</h2>
                        <p>@Model.Description</p>
                    </div>

                    <!-- Updates section (placeholder) -->
                    <div class="fund-detail-updates">
                        <h2>Updates</h2>
                        <div class="fund-detail-update-empty">
                            <span>No updates yet</span>
                            <p>The creator hasn't posted any updates for this campaign.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sidebar with donation -->
            <aside class="fund-detail-sidebar">
                <div class="fund-detail-card">
                    <!-- Progress section -->
                    <div class="fund-detail-progress-section">
                        <div class="fund-detail-amount">
                            <span class="fund-detail-raised">‚Ç¨@Model.RaisedAmount.ToString("N0")</span>
                            <span class="fund-detail-goal">raised of ‚Ç¨@Model.GoalAmount.ToString("N0") goal</span>
                        </div>

                        <div class="fund-detail-progress-bar">
                            <div class="fund-detail-progress-fill" style="--progress: @Math.Min(100, progressPercent)%;"></div>
                        </div>

                        <div class="fund-detail-stats">
                            <div class="fund-detail-stat">
                                <span class="fund-detail-stat-value">@Model.SupportersCount</span>
                                <span class="fund-detail-stat-label">supporters</span>
                            </div>
                            <div class="fund-detail-stat">
                                <span class="fund-detail-stat-value">@progressPercent%</span>
                                <span class="fund-detail-stat-label">funded</span>
                            </div>
                            <div class="fund-detail-stat">
                                <span class="fund-detail-stat-value">@(Model.DaysLeft == 0 ? "Ended" : Model.DaysLeft.ToString())</span>
                                <span class="fund-detail-stat-label">@(Model.DaysLeft == 0 ? "" : "days left")</span>
                            </div>
                        </div>
                    </div>

                    <!-- Donation buttons -->
                    <div class="fund-detail-donate-section">
                        <div class="fund-detail-quick-amounts">
                            <button class="btn-quick-amount" data-amount="10">‚Ç¨10</button>
                            <button class="btn-quick-amount" data-amount="25">‚Ç¨25</button>
                            <button class="btn-quick-amount" data-amount="50">‚Ç¨50</button>
                            <button class="btn-quick-amount" data-amount="100">‚Ç¨100</button>
                            <div class="btn-custom-amount">
                                <span class="custom-amount-label">‚Ç¨</span>
                                <input type="number" class="custom-amount-input" placeholder="Custom" min="1" id="customAmount">
                            </div>
                        </div>

                        <div class="selected-amount-display" id="selectedAmountDisplay">
                            <span class="selected-amount-label">Your donation</span>
                            <span class="selected-amount-value">‚Ç¨<span id="animatedAmount">0</span></span>
                        </div>

                        <button class="btn-donate btn-donate--primary" id="donateBtn">
                            <span class="btn-donate-icon">üíö</span>
                            Donate now
                        </button>

                        <button class="btn-donate btn-donate--ghost">
                            <span class="btn-donate-icon">üîó</span>
                            Share campaign
                        </button>
                    </div>

                    <!-- Recent supporters -->
                    <div class="fund-detail-supporters">
                        <h3>Recent supporters</h3>
                        <div class="fund-detail-supporter-list" id="supportersList">
                            @{
                                var donations = ViewBag.RecentDonations as List<KryskataFund.Models.Donation> ?? new List<KryskataFund.Models.Donation>();
                                var colors = new[] {
                                    "linear-gradient(135deg, #22c55e, #4ade80)",
                                    "linear-gradient(135deg, #4f46e5, #22d3ee)",
                                    "linear-gradient(135deg, #f97316, #fb7185)",
                                    "linear-gradient(135deg, #a855f7, #ec4899)",
                                    "linear-gradient(135deg, #facc15, #fb923c)"
                                };
                                var initialShow = 3;
                            }
                            @if (donations.Count == 0)
                            {
                                <div class="fund-detail-no-supporters" style="text-align: center; padding: 20px; color: var(--text-muted);">
                                    <p style="font-size: 13px;">No supporters yet. Be the first!</p>
                                </div>
                            }
                            else
                            {
                                var index = 0;
                                @foreach (var donation in donations)
                                {
                                    var colorIndex = Math.Abs(donation.DonorName.GetHashCode()) % colors.Length;
                                    var timeAgo = GetTimeAgo(donation.CreatedAt);
                                    var isHidden = index >= initialShow;
                                    <div class="fund-detail-supporter @(isHidden ? "supporter-hidden" : "")" data-index="@index" style="@(isHidden ? "display: none;" : "")">
                                        <div class="fund-detail-supporter-avatar" style="background: @colors[colorIndex];"></div>
                                        <div class="fund-detail-supporter-info">
                                            <span class="fund-detail-supporter-name">@donation.DonorName</span>
                                            <span class="fund-detail-supporter-amount">‚Ç¨@donation.Amount.ToString("N0")</span>
                                        </div>
                                        <span class="fund-detail-supporter-time">@timeAgo</span>
                                    </div>
                                    index++;
                                }
                            }
                        </div>
                        @if (Model.SupportersCount > 3)
                        {
                            <div class="supporters-expand-section">
                                <button type="button" class="fund-detail-see-all" id="toggleSupportersBtn" data-expanded="false">
                                    <span id="toggleText">See all @Model.SupportersCount supporters</span>
                                    <span class="toggle-arrow" id="toggleArrow">‚Üì</span>
                                </button>
                                <div class="supporters-pagination" id="supportersPagination" style="display: none;">
                                    <button type="button" class="pagination-btn" id="prevPageBtn" disabled>‚Üê</button>
                                    <span class="pagination-info" id="paginationInfo">Page 1</span>
                                    <button type="button" class="pagination-btn" id="nextPageBtn">‚Üí</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </aside>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const quickAmountBtns = document.querySelectorAll('.btn-quick-amount');
            const customAmountInput = document.getElementById('customAmount');
            const selectedAmountDisplay = document.getElementById('selectedAmountDisplay');
            const animatedAmountSpan = document.getElementById('animatedAmount');
            const donateBtn = document.getElementById('donateBtn');

            let currentAmount = 0;
            let isAnimating = false;

            // Count up animation function
            function animateCountUp(targetAmount, duration = 600) {
                if (isAnimating) return;
                isAnimating = true;

                const startAmount = 0;
                const startTime = performance.now();

                // Show the display with animation
                selectedAmountDisplay.classList.add('visible');

                function updateCount(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // Easing function (ease out cubic)
                    const easeProgress = 1 - Math.pow(1 - progress, 3);

                    const currentValue = Math.floor(startAmount + (targetAmount - startAmount) * easeProgress);
                    animatedAmountSpan.textContent = currentValue;

                    if (progress < 1) {
                        requestAnimationFrame(updateCount);
                    } else {
                        animatedAmountSpan.textContent = targetAmount;
                        isAnimating = false;
                    }
                }

                requestAnimationFrame(updateCount);
            }

            // Handle quick amount button clicks
            quickAmountBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    quickAmountBtns.forEach(b => b.classList.remove('active'));
                    customAmountInput.classList.remove('active');
                    customAmountInput.value = '';

                    // Add active class to clicked button
                    this.classList.add('active');

                    const amount = parseInt(this.dataset.amount);
                    currentAmount = amount;
                    animateCountUp(amount);
                });
            });

            // Handle custom amount input
            customAmountInput.addEventListener('input', function() {
                quickAmountBtns.forEach(b => b.classList.remove('active'));

                const amount = parseInt(this.value) || 0;
                if (amount > 0) {
                    this.classList.add('active');
                    currentAmount = amount;
                    animateCountUp(amount);
                } else {
                    this.classList.remove('active');
                    selectedAmountDisplay.classList.remove('visible');
                }
            });

            customAmountInput.addEventListener('focus', function() {
                quickAmountBtns.forEach(b => b.classList.remove('active'));
            });

            // Handle donate button click
            const fundId = @Model.Id;

            donateBtn.addEventListener('click', function() {
                if (currentAmount > 0) {
                    // Redirect to payment page
                    window.location.href = '/Funds/Donate?id=' + fundId + '&amount=' + currentAmount;
                } else {
                    // Shake animation if no amount selected
                    selectedAmountDisplay.classList.add('shake');
                    setTimeout(() => selectedAmountDisplay.classList.remove('shake'), 500);
                }
            });

            // Supporters expand/collapse with pagination
            const toggleBtn = document.getElementById('toggleSupportersBtn');
            const toggleText = document.getElementById('toggleText');
            const toggleArrow = document.getElementById('toggleArrow');
            const pagination = document.getElementById('supportersPagination');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('paginationInfo');
            const supporters = document.querySelectorAll('.fund-detail-supporter');

            const totalSupporters = @Model.SupportersCount;
            const itemsPerPage = 5;
            let currentPage = 1;
            let isExpanded = false;

            function updatePagination() {
                const totalPages = Math.ceil(supporters.length / itemsPerPage);
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, supporters.length);

                supporters.forEach((supporter, index) => {
                    if (isExpanded) {
                        if (index >= startIndex && index < endIndex) {
                            supporter.style.display = '';
                            supporter.style.animation = 'fadeSlideIn 0.3s ease forwards';
                            supporter.style.animationDelay = `${(index - startIndex) * 0.05}s`;
                        } else {
                            supporter.style.display = 'none';
                        }
                    } else {
                        // Show only first 3 when collapsed
                        supporter.style.display = index < 3 ? '' : 'none';
                    }
                });

                if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                if (prevBtn) prevBtn.disabled = currentPage === 1;
                if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            }

            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    isExpanded = !isExpanded;

                    if (isExpanded) {
                        toggleText.textContent = 'Show less';
                        toggleArrow.textContent = '‚Üë';
                        toggleArrow.style.transform = 'rotate(180deg)';
                        if (pagination && supporters.length > itemsPerPage) {
                            pagination.style.display = 'flex';
                        }
                        currentPage = 1;
                    } else {
                        toggleText.textContent = `See all ${totalSupporters} supporters`;
                        toggleArrow.textContent = '‚Üì';
                        toggleArrow.style.transform = 'rotate(0deg)';
                        if (pagination) pagination.style.display = 'none';
                    }

                    updatePagination();
                });
            }

            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    if (currentPage > 1) {
                        currentPage--;
                        updatePagination();
                    }
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    const totalPages = Math.ceil(supporters.length / itemsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        updatePagination();
                    }
                });
            }
        });
    </script>

    <style>
        .supporters-expand-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px;
        }

        .fund-detail-see-all {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(70, 230, 164, 0.1);
            border: 1px solid rgba(70, 230, 164, 0.3);
            border-radius: 10px;
            color: #46e6a4;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fund-detail-see-all:hover {
            background: rgba(70, 230, 164, 0.2);
            border-color: rgba(70, 230, 164, 0.5);
        }

        .toggle-arrow {
            transition: transform 0.3s ease;
        }

        .supporters-pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .pagination-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: rgba(70, 230, 164, 0.15);
            border-color: rgba(70, 230, 164, 0.4);
            color: #46e6a4;
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 12px;
            color: var(--text-muted);
        }

        .fund-detail-supporter {
            opacity: 0;
            animation: fadeSlideIn 0.3s ease forwards;
        }

        @@keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
}
